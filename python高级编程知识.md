# 1.pythonä¸­ä¸€åˆ‡çš†å¯¹è±¡
pythonä¸­ç±»å’Œå‡½æ•°éƒ½æ˜¯å¯¹è±¡ï¼Œå±äºpythonçš„ä¸€ç­‰å…¬æ°‘ã€‚å…·ä½“è¡¨ç°åœ¨ï¼š
1. å¯ä»¥èµ‹å€¼ç»™ä¸€ä¸ªå˜é‡
2. å¯ä»¥æ·»åŠ åˆ°é›†åˆå½“ä¸­
3. å¯ä»¥ä½œä¸ºå‡½æ•°çš„å‚æ•°
4. å¯ä»¥ä½œä¸ºå‡½æ•°çš„è¿”å›å€¼

**type object classä¹‹é—´çš„å…³ç³»**
```
a = 1
b = 'abc'
print(type(a))  # <class 'int'>
print(type(int))  # <class 'type'>
print(type(b))  # <class 'str'>
print(type(str))  # <class 'type'>

# ä»è¿™é‡Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ç”Ÿæˆå…³ç³»type->class->obj
# å¯ä»¥å¾—å‡ºç»“è®ºï¼Œä¸€èˆ¬å¯¹è±¡æ˜¯ç”±ç±»ç”Ÿæˆçš„ï¼Œè€Œç±»æ˜¯ç”±typeç”Ÿæˆçš„
```

```
print(object.__bases__) # ()
print(type.__bases__) # (<class 'object'>,)
print(type(object))  # <class 'type'>

# objectæ˜¯é¡¶å±‚åŸºç±»ï¼Œtypeä¹Ÿæ˜¯ä¸€ä¸ªç±»
# typeç±»çš„åŸºç±»æ˜¯object
# objectç±»æ˜¯ç”±typeç±»ç”Ÿæˆçš„
```
æ™®é€šå¯¹è±¡'abc'æ˜¯strç±»çš„å®ä¾‹å¯¹è±¡ï¼Œstr/int/set/dict/tupleç­‰éƒ½æ˜¯typeç±»çš„å®ä¾‹å¯¹è±¡ï¼Œtypeç±»æ˜¯typeç±»è‡ªèº«çš„å®ä¾‹å¯¹è±¡ï¼Œè€Œä»–ä»¬æ‰€æœ‰éƒ½ç»§æ‰¿è‡ªobjectç±»ã€‚ä½†æ˜¯éœ€è¦æ³¨æ„çš„æ˜¯âš ï¸objectç±»ä¹Ÿæ˜¯typeç±»çš„å®ä¾‹å¯¹è±¡ã€‚å› æ­¤pythonä¸­ä¸€åˆ‡çš†å¯¹è±¡ï¼Œè€Œå¯¹è±¡éƒ½æ˜¯å¯ä»¥ä¿®æ”¹çš„ã€‚

pythonä¸­çš„å¯¹è±¡æœ‰3ä¸ªç‰¹å¾ï¼šèº«ä»½/idã€ç±»å‹/typeã€å€¼/valueã€‚

pythonä¸­å¸¸è§çš„å†…ç½®ç±»å‹ï¼šNone(å…¨å±€å”¯ä¸€)ï¼Œè¿­ä»£ç±»å‹ï¼Œåºåˆ—ç±»å‹(list/tuple/str/bytesç­‰),æ˜ å°„ç±»å‹(dict)ï¼Œé›†åˆç±»å‹ï¼Œä¸Šä¸‹æ–‡ç®¡ç†å™¨ç±»å‹(with),å…¶ä»–ç±»å‹(æ¨¡å—ç±»å‹/å®ä¾‹ç±»å‹/æ–¹æ³•ç±»å‹ç­‰)

# 2.pythonä¸­çš„é­”æ³•å‡½æ•°
* pythonä¸­ä»¥åŒä¸‹åˆ’çº¿å¼€å¤´å’Œç»“å°¾çš„å‡½æ•°ï¼Œç§°ä¸ºé­”æ³•å‡½æ•°
* ä»¥å•ä¸‹åˆ’çº¿å¼€å¤´è¡¨ç¤ºä¸æ˜¯APIçš„ä¸€éƒ¨åˆ†ï¼Œä¸æä¾›å¯¹å¤–è®¿é—®(è™½ç„¶ç›´æ¥è®¿é—®ä¹Ÿæ²¡æœ‰é—®é¢˜)
* ä»¥åŒä¸‹åˆ’çº¿å¼€å¤´è¡¨ç¤ºä¸èƒ½é‡å†™è¯¥æ–¹æ³•ï¼Œé‡å†™æ— æ•ˆï¼Œä¸èƒ½ç›´æ¥è®¿é—®(å¯ä»¥é€šè¿‡_className__method()æ¥è®¿é—®)
* ä»¥åŒä¸‹åˆ’çº¿å¼€å¤´ç»“å°¾è¡¨ç¤ºæ˜¯pythonè‡ªå·±å†…ç½®è°ƒç”¨çš„ï¼Œä¸è¦ç›´æ¥è°ƒç”¨

å¦‚__getitem__å®ç°å¯è¿­ä»£å¯¹è±¡ï¼Œè€Œ__iter__å®ç°è¿­ä»£å™¨ï¼Œè¿­ä»£ä¸€ä¸ªå¯¹è±¡æ—¶ï¼Œä¼šå…ˆæ‰¾__iter__ï¼Œå¦‚æœæ²¡æœ‰å®ç°å°±æ‰¾__getitem__ã€‚

è¿˜æœ‰len()å‡½æ•°ä¼šæŸ¥æ‰¾æ˜¯å¦å®ç°äº†__len__ï¼Œå¦å¤–print()å‡½æ•°ä¼šå…ˆæ‰¾__str__æ˜¯å¦å®ç°ï¼Œå¦‚æœæ²¡æœ‰å°±æ‰¾__repr__ã€‚

è¿˜æœ‰å…¶ä»–å¾ˆå¤šæ•°å­¦è¿ç®—å‡½æ•°ï¼Œæ¯”å¦‚__abs__ä»¥åŠ__sum__è¿˜æœ‰__add__ç­‰ã€‚
```
class A:
    def __init__(self, lst):
        self.lst = lst

    # é­”æ³•æ–¹æ³•ï¼Œä½¿å¾—Açš„å®ä¾‹å¯¹è±¡æˆä¸ºå¯è¿­ä»£å¯¹è±¡ï¼Œä¹Ÿæˆä¸ºäº†åºåˆ—ç±»å‹
    def __getitem__(self, item):
        return self.lst[item]

    # å¯ä»¥è·å–ä¼ å…¥åˆ—è¡¨çš„é•¿åº¦
    def __len__(self):
        return len(self.lst)

    # æ ¼å¼åŒ–è¾“å‡ºçš„å¯¹è±¡
    def __str__(self):
        return ','.join(self.lst)

    # å¼€å‘æ¨¡å¼çš„åŸå§‹å¯¹è±¡
    def __repr__(self):
        return ','.join(self.lst)


a = A(['x', 'y', 'z'])

# __getitem__å®ç°åºåˆ—ç±»å‹ï¼Œå¯åˆ‡ç‰‡
print(a[:2])
# __getitem__ç›´æ¥è¿­ä»£aå¯¹è±¡ï¼Œè€Œä¸æ˜¯a.lst
for i in a:
    print(i)
# å®é™…è°ƒç”¨__len__
print(len(a))
# æ²¡æœ‰å®ç°__repr__æ—¶
print(repr(a))  # <__main__.A object at 0x10c304a90>
# å®ç°äº†__repr__æ—¶
print(repr(a))  # x,y,z
# æ²¡æœ‰å®ç°__str__å’Œ__repr__æ—¶
print(a)  # <__main__.A object at 0x10e897a90>
# å®ç°äº†__str__æˆ–è€…__repr__
print(a)  # x,y,z
```

# 3.æ·±å…¥ç±»å’Œå¯¹è±¡
é¸­å­ç±»å‹å°±æ˜¯å¤šæ€çš„ä½“ç°ï¼Œæ˜¯pythonçš„ç‰¹æ€§ä¹‹ä¸€ã€‚åœ¨Javaç­‰é™æ€è¯­è¨€ä¸­å®ç°å¤šæ€ï¼Œéœ€è¦ç»§æ‰¿çˆ¶ç±»å¹¶é‡å†™æ–¹æ³•ã€‚è€Œpythonçš„é¸­å­ç±»å‹ï¼Œå…·ä½“æ¥è®²å°±æ˜¯ä¸åŒçš„ç±»éƒ½å®ç°äº†åŒä¸€ä¸ªåç§°çš„æ–¹æ³•ï¼Œé‚£ä¹ˆåœ¨è°ƒç”¨è¿™ä¸ªæ–¹æ³•çš„æ—¶å€™ï¼Œå¯ä»¥æŠŠè¿™äº›ä¸åŒçš„ç±»çœ‹ä½œç›¸åŒçš„å¯¹è±¡ã€‚æ¯”å¦‚listå¯ä»¥extendä¸€ä¸ªå¯è¿­ä»£å¯¹è±¡ï¼Œé‚£ä¹ˆlistå°±ä¸ä»…ä»…å¯ä»¥extendå¦ä¸€ä¸ªlistï¼Œè¿˜å¯ä»¥extendä¸€ä¸ªtupleï¼Œsetç­‰å¾…ï¼Œåªè¦ç±»å‹æ˜¯å¯è¿­ä»£çš„ï¼Œå°±å¯ä»¥è¢«extendï¼Œè¿™å°±æ˜¯é¸­å­ç±»å‹ï¼Œçœ‹ç€åƒé¸­å­ï¼Œé‚£å°±å¯ä»¥å½“æˆé¸­å­ğŸ¦†ã€‚

pythonå’ŒJavaçš„å˜é‡å­˜åœ¨ç€æœ¬è´¨ä¸åŒã€‚Javaå˜é‡æ˜¯å®šä¹‰æ—¶ç”³è¯·çš„ä¸€å—å†…å­˜ç©ºé—´ï¼Œæ˜¯ä¸€ä¸ªç›’å­ï¼›pythonå˜é‡æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼Œæ˜¯ä¸€ä¸ªä¾¿åˆ©è´´ã€‚ä¾‹å¦‚åœ¨`a=1`è¿™å¥ä»£ç ä¸­ï¼Œpythonçš„æœ¬è´¨æ˜¯å…ˆå‘å†…å­˜ç”³è¯·ä¸€ä¸ªintç±»å‹çš„ç©ºé—´æ¥æ”¾ç½®1ï¼Œç„¶åæŠŠaè´´åœ¨å¯¹è±¡1ä¸Šé¢ï¼Œæ‰€ä»¥å†æœ‰a='2'æ—¶ï¼Œå°±æ˜¯æŠŠaè´´åœ¨å¯¹è±¡2ä¸Šï¼Œè€Œä¸æ˜¯æŠŠ2åˆ†é…ç»™aï¼›å¯¹äºJavaæ¥è®²ï¼Œåˆ™æ˜¯æŠŠå¯¹è±¡2æ”¾åœ¨äº†aè¿™ä¸ªç›’å­é‡Œé¢ã€‚

å› æ­¤æœ‰
```
a=[1,2]
b=a
b.append(3)
a.append(4)
print(a)  # [1,2,3,4]
```
è¿™å°±æ˜¯ä¾¿åˆ©è´´çš„ä½“ç°ï¼Œbè´´åœ¨äº†aä¸Šé¢ï¼Œè€Œaè´´åœ¨äº†å¯¹è±¡`[1,2]`ä¸Šé¢ï¼Œæ‰€ä»¥aå’Œbå…¶å®éƒ½æ˜¯æŒ‡å‘äº†åŒä¸€ä¸ªå¯¹è±¡ï¼Œå³`a is b`æ˜¯Trueã€‚

**å…³äº==å’Œisçš„åŒºåˆ«**

`==`æ¯”è¾ƒçš„æ˜¯å€¼ï¼Œè€Œ`is`æ¯”è¾ƒçš„æ˜¯id()ï¼Œå¦å¤–å¯¹äºå°æ•´æ•°å’ŒçŸ­å­—ç¬¦ä¸²ï¼Œpythonå†…éƒ¨æœ‰é©»ç•™æœºåˆ¶ï¼Œä¿å­˜åœ¨å†…å­˜ä¸­ï¼Œæ¯æ¬¡ç”³è¯·éƒ½æ˜¯åŒä¸€ä¸ªå¯¹è±¡ã€‚

**pythonçš„è‡ªçœæœºåˆ¶**

æ‰€è°“çš„pythonè‡ªçœæœºåˆ¶ï¼ŒæŒ‡çš„å°±æ˜¯é€šè¿‡ä¸€å®šçš„æœºåˆ¶æŸ¥è¯¢åˆ°å¯¹è±¡å†…éƒ¨ç»“æ„ã€‚å¯¹äº__dict__å¯ä»¥æŸ¥è¯¢å¯¹è±¡çš„å†…éƒ¨å±æ€§ï¼Œdir()åˆ™æ˜¯åˆ—å‡ºå¯¹è±¡çš„æ‰€æœ‰å±æ€§åç§°ã€‚

**pythonçš„å¤šé‡ç»§æ‰¿**

é¦–å…ˆä¸æ¨èä½¿ç”¨å¤šé‡ç»§æ‰¿ï¼Œè¿™ä¼šå¯¼è‡´å¤æ‚æƒ…å†µã€‚pythonçš„å¤šé‡ç»§æ‰¿æŒ‰ç…§MROæ–¹æ³•è§£æé¡ºåºï¼Œä»å·¦åˆ°å³ï¼Œæ–°å¼ç±»å¹¿åº¦ä¼˜å…ˆã€‚super()è°ƒç”¨çš„æ—¶å€™ï¼Œä»å·¦åˆ°å³ï¼Œç»§æ‰¿çš„åŒçº§é—´åªæ‰§è¡Œå·¦ã€‚
```
class A:
    def __init__(self):
        print('enter A')
        print('leave A')

class B:
    def __init__(self):
        print('enter B')
        print('leave B')

class C(B):
    def __init__(self):
        print('enter C')
        super().__init__()
        print('leave C')

class D(B,A):
    def __init__(self):
        print('enter D')
        super().__init__()
        print('leave D')

class E(C,D):
    def __init__(self):
        print('enter E')
        super().__init__()
        print('leave E')

class F(C):
    def __init__(self):
        print('enter F')
        super().__init__()
        print('leave F')

print(B())
print(C())
print(C.mro())
print(D())
print(D.mro())
print(E())
print(E.mro())
print(F())
print(F.__mro__)

# enter B
# leave B
# <__main__.B object at 0x1079cd7b8>
# enter C
# enter B
# leave B
# leave C
# <__main__.C object at 0x1079cd7b8>
# [<class '__main__.C'>, <class '__main__.B'>, <class 'object'>]
# enter D
# enter B
# leave B
# leave D
# <__main__.D object at 0x1079cd7b8>
# [<class '__main__.D'>, <class '__main__.B'>, <class '__main__.A'>, <class 'object'>]
# enter E
# enter C
# enter D
# enter B
# leave B
# leave D
# leave C
# leave E
# <__main__.E object at 0x1079cd7b8>
# [<class '__main__.E'>, <class '__main__.C'>, <class '__main__.D'>, <class '__main__.B'>, <class '__main__.A'>, <class 'object'>]
# enter F
# enter C
# enter B
# leave B
# leave C
# leave F
# <__main__.F object at 0x1079cd7b8>
# (<class '__main__.F'>, <class '__main__.C'>, <class '__main__.B'>, <class 'object'>)

```

# 4.pythonå…ƒç±»ç¼–ç¨‹
@propertyåŠ¨æ€å±æ€§ï¼Œå¯ä»¥æŠŠæ–¹æ³•è°ƒç”¨æ”¹å˜æˆå±æ€§è°ƒç”¨ã€‚

`__getattr__`æ˜¯å±æ€§è®¿é—®çš„å‡ºå£ï¼Œåœ¨æ‰¾ä¸åˆ°å¯¹è±¡å±æ€§çš„æ—¶å€™ï¼Œä¼šè¿›å…¥æ­¤æ–¹æ³•ï¼Œå¯ä»¥åœ¨æ­¤æ·»åŠ ä¸€äº›çµæ´»çš„é€»è¾‘ã€‚

`__getattribute__`æ˜¯å±æ€§è®¿é—®çš„å…¥å£ï¼Œæ‰¾å¯¹è±¡å±æ€§ä¼šé¦–å…ˆè¿›å…¥æ­¤æ–¹æ³•ï¼Œä¸€èˆ¬ä¸èƒ½é‡å†™ã€‚

å±æ€§æè¿°ç¬¦ï¼šä¸€ä¸ªç±»ä¸­å®ç°äº†`__get__`,`__set__`,`__delete__`ä¸‰ä¸ªé­”æ³•æ–¹æ³•ä¸­çš„ä»»æ„ä¸€ä¸ªï¼Œéƒ½æ˜¯å±æ€§æè¿°ç¬¦ã€‚é€šè¿‡å±æ€§æè¿°ç¬¦ï¼Œå¯ä»¥å¯¹ä¼ å…¥çš„å±æ€§å€¼è¿›è¡Œä¸€ç³»åˆ—çš„ç±»å‹æ£€æŸ¥å’ŒèŒƒå›´æ£€æŸ¥ç­‰ã€‚

æ¯”å¦‚å®šä¹‰Userç±»çš„ageå­—æ®µï¼Œéœ€è¦æ˜¯ä¸€ä¸ªIntField()ç±»å‹ï¼Œé‚£ä¹ˆIntFieldå°±æ˜¯ä¸€ä¸ªå±æ€§æè¿°ç¬¦ã€‚

**å…³äº__new__å’Œ__init__çš„åŒºåˆ«**

å®ä¾‹åŒ–ä¸€ä¸ªç±»æ—¶ï¼Œå…ˆè°ƒç”¨__new__æ–¹æ³•ï¼Œå†è°ƒç”¨__init__æ–¹æ³•ï¼Œå¦‚æœnewä¸è¿”å›ç±»å¯¹è±¡ï¼Œåˆ™ä¸ä¼šè°ƒç”¨initæ–¹æ³•ï¼Œå³newæ˜¯æ§åˆ¶ç±»ç”Ÿæˆçš„é­”æ³•æ–¹æ³•ã€‚
```
class Us:
    def __new__(cls, *args, **kwargs):
        return super().__new__(cls)

    def __init__(self, *args, **kwargs):
        pass

```

**å…³äºtypeåŠ¨æ€åˆ›å»ºç±»**

```
def say(self):
    '''ä¼ é€’ç»™åŠ¨æ€åˆ›å»ºç±»çš„æ–¹æ³•'''
    return 'hello'
class BaseClass:
    '''ä¼ é€’ç»™åŠ¨æ€åˆ›å»ºç±»çš„çˆ¶ç±»'''
    def answer(self):
        return 'this is baseclass'
User = type('User',(BaseClass,),{'name':'abc', 'say':say})
user = User()
print(user.name)  # abc
print(user.say())  # hello
print(user.answer())  # this is baseclass

```

pythonä¸­ç±»çš„å®ä¾‹åŒ–è¿‡ç¨‹ï¼Œä¼šé¦–å…ˆå¯»æ‰¾metaclassï¼Œé€šè¿‡metaclassæ¥åˆ›å»ºUserç±»ï¼›å¦‚æœæ‰¾ä¸åˆ°ï¼Œå°±å»çˆ¶ç±»ä¸­æ‰¾metaclassï¼Œè¿˜æ²¡æœ‰æ‰¾åˆ°å°±å»æ¨¡å—ä¸­æ‰¾ï¼Œéƒ½æ‰¾ä¸åˆ°ï¼Œæ‰ä¼šä½¿ç”¨typeåˆ›å»ºç±»ã€‚

å…ƒç±»å°±æ˜¯åˆ›å»ºç±»çš„ç±»ï¼Œå…ƒç±»ç¼–ç¨‹å¯ä»¥æ·±åº¦å®šåˆ¶éœ€æ±‚ï¼Œå¢å¼ºä»£ç å¥å£®æ€§ï¼Œä¸€èˆ¬æ˜¯é«˜çº§ç¼–ç¨‹ä½¿ç”¨ï¼Œæ¯”å¦‚å†™ä¸€ä¸ªæ¡†æ¶ã€‚
```
class MetaClass(type):
    pass
class User(metaclass=MetaClass):
    pass

```

# 5.pythonå¤šçº¿ç¨‹ä¸å¤šè¿›ç¨‹ç¼–ç¨‹
ç”±äºGILé”çš„å­˜åœ¨ï¼Œpythonä¸­åŒä¸€æ—¶åˆ»åªæœ‰ä¸€ä¸ªçº¿ç¨‹è¿è¡Œåœ¨ä¸€ä¸ªcpuä¸Šï¼Œä¸èƒ½å¤šä¸ªçº¿ç¨‹æ˜ å°„åˆ°å¤šä¸ªcpuä¸Šã€‚GILä¼šåœ¨é‡åˆ°IOæ“ä½œæˆ–è€…æ‰§è¡Œä¸€å®šæ—¶é—´ç‰‡åä¸»åŠ¨é‡Šæ”¾ã€‚

å¯¹äºIOæ“ä½œæ¥è¯´ï¼Œå¤šçº¿ç¨‹å’Œå¤šè¿›ç¨‹æ€§èƒ½å·®åˆ«ä¸å¤§ï¼Œå¯èƒ½è¿˜ä¼šç”±äºå¤šè¿›ç¨‹çš„èµ„æºå¼€é”€å¤§å¯¼è‡´æ€§èƒ½åè€Œæ›´ä½
```
thread.start()  # å¼€å¯çº¿ç¨‹
thread.setDaemon(True)  # è®¾ç½®å®ˆæŠ¤çº¿ç¨‹ï¼Œä¸»çº¿ç¨‹è¿è¡Œå®Œæ¯•åkillæ‰å½“å‰çº¿ç¨‹ï¼Œéœ€è¦åœ¨start()å‰è°ƒç”¨
thread.join()  # è®¾ç½®çº¿ç¨‹ç­‰å¾…ï¼Œä¸»çº¿ç¨‹ç­‰å¾…å½“å‰çº¿ç¨‹æ‰§è¡Œå®Œæ¯•ä¹‹åå†é€€å‡º
```

çº¿ç¨‹é—´é€šä¿¡æ–¹å¼ï¼šå…±äº«å˜é‡ï¼Œé˜Ÿåˆ—ã€‚å…±äº«å˜é‡çš„æ–¹å¼ï¼Œçº¿ç¨‹ä¸å®‰å…¨ï¼Œéœ€è¦åŠ é”ã€‚queue.Queueé˜Ÿåˆ—æ˜¯çº¿ç¨‹å®‰å…¨çš„åŒç«¯é˜Ÿåˆ—ï¼Œæœ¬è´¨ä¸Šé‡‡ç”¨deque

è¿›ç¨‹é—´é€šä¿¡çš„æ–¹å¼ï¼šmultiprocessing.Queueï¼Œpipe(2ä¸ªè¿›ç¨‹é—´é€šä¿¡), å†…å­˜å…±äº«Managerã€‚è¿›ç¨‹é—´ä¸èƒ½é‡‡ç”¨å…±äº«å˜é‡çš„æ–¹å¼æ¥é€šä¿¡ï¼Œè€Œmultiprocessingçš„Queueä¸èƒ½ç”¨äºè¿›ç¨‹æ± Poolï¼ŒPoolä¸­çš„è¿›ç¨‹é—´é€šä¿¡éœ€è¦ä½¿ç”¨managerä¸­çš„Queueã€‚çº¿ç¨‹æ± å’Œè¿›ç¨‹æ± ï¼Œéœ€è¦pool.close()ï¼Œå†pool.join()ã€‚
```
from queue import Queue            # çº¿ç¨‹é—´ç”¨
from multiprocessing import Queue  # è¿›ç¨‹é—´ç”¨
from multiprocessing import Manager 
Manager().Queue()                  # è¿›ç¨‹æ± ç”¨

```
ç®¡é“pipeåªèƒ½ç”¨äº2ä¸ªè¿›ç¨‹é—´é€šä¿¡ï¼Œä¸€ä¸ªpipe.send(),ä¸€ä¸ªpipe.recv()

**çº¿ç¨‹åŒæ­¥**

å¯¹äº`a += 1`è¿™ä¸€è¯­å¥ï¼Œä»å­—èŠ‚ç çš„å±‚é¢çœ‹æœ‰4æ­¥ï¼Œè¿™ä¸­é—´å¯èƒ½ä¼šäº§ç”Ÿçº¿ç¨‹åˆ‡æ¢ï¼Œå¯¼è‡´é”™è¯¯ï¼š
1. load a
2. load 1
3. æ‰§è¡Œ+
4. èµ‹å€¼ç»™a

çº¿ç¨‹åŒæ­¥ï¼Œå¯ä»¥é‡‡ç”¨é”ï¼Œä½†æ˜¯é”ä¼šå½±å“æ€§èƒ½ï¼Œè¿˜å¯èƒ½å¯¼è‡´æ­»é”ã€‚é”æœ‰2ç§ï¼ŒLockå’ŒRLock(å¯é‡å…¥çš„é”)ï¼Œåœ¨åŒä¸€çº¿ç¨‹ä¸­ï¼ŒLockåªèƒ½ä¸€æ¬¡acquire()æ¥ç€ä¸€æ¬¡release(),å¦‚æœè¿ç»­ä¸¤æ¬¡acquireå°±ä¼šæ­»é”ï¼ŒRLockåˆ™å¯ä»¥åœ¨åŒä¸€ä¸ªçº¿ç¨‹ä¸­ï¼Œå¤šæ¬¡acquireï¼Œåªè¦å’Œreleaseç›¸å¯¹åº”æ¬¡æ•°å°±å¯ä»¥ã€‚

è¿˜å¯ä»¥é‡‡ç”¨conditionï¼Œæ¡ä»¶å˜é‡ï¼Œç”¨äºå¤æ‚çš„çº¿ç¨‹åŒæ­¥(å†…éƒ¨è°ƒç”¨çš„è¿˜æ˜¯RLock)ã€‚æ¨¡å‹å¦‚ä¸‹ï¼š
```
# å¯¹äºç”Ÿäº§è€…ï¼š(å¦‚æœä¸ç”¨withéœ€è¦åœ¨å‰ååŠ ä¸Šacquireå’Œrelease)
with cond:
    do_somethong()
    condition.notify()
    condition.wait()
# å¯¹äºæ¶ˆè´¹è€…
with cond:
    condition.wait()
    do_somethong()
    condition.notify()
  
# ç”Ÿäº§è€…é€šçŸ¥æ¶ˆè´¹è€…ï¼Œéœ€è¦æ¶ˆè´¹è€…å…ˆå¤„äºwait()çŠ¶æ€
```
å¯åŠ¨çº¿ç¨‹çš„æ—¶å€™ï¼Œæ¶ˆè´¹è€…è¦å…ˆå¯åŠ¨ç­‰å¾…ï¼Œç”Ÿäº§è€…å†å¯åŠ¨ï¼Œå¦åˆ™ç”Ÿäº§è€…çš„ä¿¡å·å‘å‡ºå»äº†ï¼Œæ¶ˆè´¹è€…è¿˜æ²¡æœ‰å¯åŠ¨ï¼Œå°±æ— æ³•æ¥æ”¶åˆ°ä¿¡å·ã€‚

conditionæœ‰2å±‚é”ï¼Œåº•å±‚é”ä¼šåœ¨çº¿ç¨‹è°ƒç”¨waitæ–¹æ³•åé‡Šæ”¾ï¼Œé¡¶å±‚é”ä¼šåœ¨è°ƒç”¨waitçš„æ—¶å€™åˆ†é…ä¸€æŠŠå¹¶æ”¾åœ¨conditionçš„ç­‰å¾…é˜Ÿåˆ—ä¸­ï¼Œç­‰å¾…notifyæ–¹æ³•çš„å”¤é†’ã€‚

Semaphore ä¿¡å·é‡ï¼Œæ˜¯ç”¨äºæ§åˆ¶è¿›å…¥æ•°é‡çš„é”(å†…éƒ¨ä½¿ç”¨conditionå®ç°çš„)ã€‚åœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­acquireï¼Œåœ¨å¦ä¸€ä¸ªçº¿ç¨‹ä¸­releaseï¼Œéœ€è¦è¢«ä¼ å‚

å¤šçº¿ç¨‹å¯ä»¥ä½¿ç”¨threadingåº“ï¼ŒThreadPoolExecutor;å¤šè¿›ç¨‹å¯ä»¥ä½¿ç”¨multiprocessingï¼ŒProcessPoolExecutor

# 6.åç¨‹ä¸å¼‚æ­¥IO
* å¹¶å‘(ä¸€ä¸ªæ—¶é—´æ®µå†…ï¼Œå¤šä¸ªç¨‹åºåœ¨ä¸€ä¸ªcpuä¸Šè¿è¡Œï¼Œä»»æ„æ—¶åˆ»åªæœ‰ä¸€ä¸ªç¨‹åºè¿è¡Œ)
* å¹¶è¡Œ(ä»»æ„æ—¶é—´ç‚¹ï¼Œå¤šä¸ªç¨‹åºåœ¨å¤šä¸ªcpuä¸ŠåŒæ—¶è¿è¡Œ)
* åŒæ­¥(ä»£ç è°ƒç”¨IOæ“ä½œæ—¶ï¼Œå¿…é¡»ç­‰å¾…IOæ“ä½œå®Œæˆæ‰è¿”å›çš„è°ƒç”¨æ–¹å¼)
* å¼‚æ­¥(ä»£ç è°ƒç”¨IOæ“ä½œæ—¶ï¼Œä¸å¿…ç­‰IOæ“ä½œå®Œæˆå°±ç«‹å³è¿”å›çš„è°ƒç”¨æ–¹å¼)
* é˜»å¡(è°ƒç”¨å‡½æ•°æ—¶ï¼Œå½“å‰çº¿ç¨‹è¢«æŒ‚èµ·)
* éé˜»å¡(è°ƒç”¨å‡½æ•°æ—¶ï¼Œå½“å‰å‡½æ•°ä¸ä¼šè¢«æŒ‚èµ·ï¼Œè€Œæ˜¯ç«‹å³è¿”å›)
* åŒæ­¥/å¼‚æ­¥æ˜¯æ¶ˆæ¯é€šä¿¡çš„ä¸€ç§æœºåˆ¶
* é˜»å¡/éé˜»å¡æ˜¯å‡½æ•°è°ƒç”¨çš„ä¸€ç§æœºåˆ¶

C10Ké—®é¢˜ï¼šå¦‚ä½•åœ¨1æ ¸1GHzçš„CPUï¼Œ2Gå†…å­˜ï¼Œ1gbpsç½‘ç»œç¯å¢ƒä¸‹ï¼Œè®©å•å°æœåŠ¡å™¨åŒæ—¶ä¸º1ä¸‡ä¸ªå®¢æˆ·ç«¯æä¾›FTPæœåŠ¡

C10Mé—®é¢˜ï¼šå¦‚ä½•åˆ©ç”¨8æ ¸CPUï¼Œ64Gå†…å­˜ï¼Œåœ¨10gbpsçš„ç½‘ç»œä¸Šä¿æŒ1000ä¸‡å¹¶å‘è¿æ¥

Unixä¸‹5ä¸­I/Oæ¨¡å‹ï¼šé˜»å¡å¼ï¼Œéé˜»å¡å¼ï¼ŒI/Oå¤ç”¨ï¼Œä¿¡å·é©±åŠ¨å¼ï¼Œå¼‚æ­¥I/Oã€‚å¤§å¤šæ•°å¼‚æ­¥æ¡†æ¶ä½¿ç”¨çš„æŠ€æœ¯è¿˜æ˜¯IOå¤šè·¯å¤ç”¨ï¼Œå› ä¸ºæŠ€æœ¯æ›´åŠ æˆç†Ÿï¼Œè€Œä¸æ˜¯å¼‚æ­¥IOçš„aioã€‚è€Œå¾ˆå¤šå¼‚æ­¥IOçš„æ¡†æ¶æ¨¡å‹ä¸­ï¼Œå®é™…ä¸Šé‡‡ç”¨çš„éƒ½æ˜¯ä¸€ç§epoll+å›è°ƒ+äº‹ä»¶å¾ªç¯çš„æ–¹å¼ã€‚

I/Oå¤šè·¯å¤ç”¨ï¼šé€šè¿‡ä¸€ç§æœºåˆ¶ï¼Œä¸€ä¸ªè¿›ç¨‹å¯ä»¥ç›‘è§†å¤šä¸ªFDæ–‡ä»¶æè¿°ç¬¦ï¼Œä¸€æ—¦æŸä¸ªæè¿°ç¬¦å°±ç»ª(ä¸€èˆ¬æ˜¯è¯»å†™å°±ç»ª)ï¼Œå°±é€šçŸ¥ç¨‹åºè¿›è¡Œç›¸åº”è¯»å†™æ“ä½œã€‚

ä¸‰ç§æŠ€æœ¯ï¼šselectï¼Œpollï¼Œepollï¼Œæœ¬è´¨ä¸Šéƒ½æ˜¯åŒæ­¥I/Oï¼Œå› ä¸ºä»–ä»¬éƒ½éœ€è¦åœ¨å°±ç»ªåè‡ªå·±å¤æ‚è¯»å†™ï¼Œå³è‡ªå·±æ—¢è´Ÿè´£ç›‘å¬ï¼Œåˆè´Ÿè´£è¯»å†™æ“ä½œã€‚æ‰€è°“çš„è¯»å†™æ“ä½œï¼Œå°±æ˜¯æŠŠæ•°æ®ä»å†…æ ¸ç©ºé—´æ‹·è´åˆ°ç”¨æˆ·ç©ºé—´ï¼Œè€Œå¼‚æ­¥I/Oæ— éœ€åšè¿™ä¸€æ­¥å› ä¸ºæ“ä½œç³»ç»Ÿå®Œæˆè¿™ä¸ªæ“ä½œåæ‰é€šçŸ¥ã€‚
* selectä¼˜ç‚¹æ˜¯è‰¯å¥½çš„è·¨å¹³å°æ”¯æŒï¼Œç¼ºç‚¹æ˜¯è™½ç„¶å¯ä»¥ç›‘å¬å¤šä¸ªsocketçŠ¶æ€ä½†æ˜¯æœ‰æ•°é‡é™åˆ¶ï¼Œä¸”éœ€è¦å…¨éƒ¨è½®è¯¢è·å–å°±ç»ªçš„æè¿°ç¬¦
* pollè§£å†³äº†æœ€å¤§ç›‘å¬æ•°é‡çš„é™åˆ¶ï¼Œä½†æ˜¯ä»ç„¶éœ€è¦è½®è¯¢è·å–å°±ç»ªæè¿°ç¬¦
* epollæ›´åŠ çµæ´»ï¼Œæ²¡æœ‰æè¿°ç¬¦é™åˆ¶ï¼Œä½†æ˜¯ä¸æ”¯æŒwinå¹³å°

epollå¹¶ä¸æ¯”selectå°±å¥½ã€‚åœ¨é«˜å¹¶å‘ï¼Œè¿æ¥æ´»è·ƒåº¦ä¸é«˜çš„æƒ…å†µä¸‹ï¼Œepollæ›´å¥½ã€‚ä½†æ˜¯åœ¨å¹¶å‘ä¸é«˜ï¼Œè¿æ¥æ´»è·ƒçš„æƒ…å†µä¸‹ï¼Œselectæ›´å¥½ã€‚

**åç¨‹**

å¯ä»¥æš‚åœå¹¶æ¢å¤çš„å‡½æ•°ï¼Œä¸”å¯ä»¥å‘æš‚åœçš„å¯¹æ–¹ä¼ å€¼ã€‚ä¸»è¦æ˜¯ä¸ºäº†è§£å†³å¦‚ä¸‹é—®é¢˜ï¼š
1. å›è°ƒæ¨¡å¼ç¼–å†™ä»£ç å¤æ‚åº¦é«˜
2. åŒæ­¥ç¼–ç¨‹çš„å¹¶å‘æ€§ä¸é«˜
3. å¤šçº¿ç¨‹ç¼–ç¨‹éœ€è¦çº¿ç¨‹åŒæ­¥ï¼Œlockå½±å“æ€§èƒ½ 

æ‰€ä»¥åç¨‹å…·æœ‰ä»¥ä¸‹åŠŸèƒ½ï¼š
1. é‡‡ç”¨åŒæ­¥æ–¹å¼å»ç¼–å†™å¼‚æ­¥çš„ä»£ç 
2. é‡‡ç”¨å•çº¿ç¨‹å»åˆ‡æ¢ä»»åŠ¡

ä½¿ç”¨å•çº¿ç¨‹æ„å‘³ç€æˆ‘ä»¬éœ€è¦è‡ªå·±è°ƒåº¦ä»»åŠ¡ï¼Œè€Œä¸æ˜¯æ“ä½œç³»ç»Ÿè‡ªåŠ¨åˆ‡æ¢ã€‚å•çº¿ç¨‹ä¸éœ€è¦é”ï¼Œå¹¶å‘æ€§é«˜ï¼Œçº¿ç¨‹å†…åˆ‡æ¢å‡½æ•°æ€§èƒ½è¿œé«˜äºçº¿ç¨‹é—´åˆ‡æ¢

åˆ©ç”¨ç”Ÿæˆå™¨æ¥å®Œæˆåç¨‹ï¼Œç”Ÿæˆå™¨ä¸åªå¯ä»¥äº§å‡ºå€¼ï¼Œè¿˜å¯ä»¥æ¥æ”¶å€¼ã€‚å¯åŠ¨ç”Ÿæˆå™¨æœ‰2ç§æ–¹å¼ï¼Œnextå’Œsend
```
# åŸºæœ¬ç”Ÿæˆå™¨
def gen_func():
    yield 1
    yield 2
    return 'ok'
gen = gen_func()
print(next(gen))  # 1
print(next(gen))  # 2
print(next(gen))  # StopIteration: ok

# å¯ä»¥ä¼ å€¼çš„ç”Ÿæˆå™¨
def gen_func2():
    # å¯¹yieldè¿›è¡Œèµ‹å€¼æ—¶ï¼Œ1å¯ä»¥ç”Ÿæˆå€¼ï¼Œ2å¯ä»¥æ¥æ”¶å€¼
    html = yield 'http;//www.baidu.com'
    print(html)  # hello yield
    yield 2
    return 'ok'
gen2 = gen_func2()
# åœ¨è°ƒç”¨sendä¹‹å‰ï¼Œéœ€è¦å¯åŠ¨ä¸€æ¬¡ç”Ÿæˆå™¨ï¼Œä¸”å¿…é¡»æ˜¯gen2.send(None)ï¼Œæˆ–è€…é‡‡ç”¨next(gen2)çš„æ–¹å¼
url = gen2.send(None)
# download url
html = 'hello yield'
# sendæ–¹æ³•å¯ä»¥ä¼ é€’å€¼åˆ°ç”Ÿæˆå™¨å†…éƒ¨ï¼ŒåŒæ—¶è¿˜å¯ä»¥å¯åŠ¨ç”Ÿæˆå™¨æ‰§è¡Œåˆ°ä¸‹ä¸€ä¸ªyieldä½ç½®
print(gen2.send(html))  # 2

```

**yield from iterable**

å¯ä»¥å°†å¯è¿­ä»£åºåˆ—é‡Œçš„å€¼ä¸€ä¸ªä¸€ä¸ªyieldå‡ºæ¥ï¼Œä¸ä»…å¦‚æ­¤ï¼Œyield fromè¿˜å¯ä»¥å»ºç«‹è°ƒç”¨æ–¹ä¸å­ç”Ÿæˆå™¨çš„åŒå‘é€šé“
```
# yieldå’Œyield from
def g1(iterable):
    yield iterable
def g2(iterable):
    yield from iterable

for value in g1(range(3)):
    print(value)  # range(0, 3)
for value in g2(range(3)):
    print(value)  # 0,1,2


# å§”æ‰˜ç”Ÿæˆå™¨
def g1(gen):
    # genæ˜¯å­ç”Ÿæˆå™¨
    yield from gen  # yield fromä¼šåœ¨è°ƒç”¨æ–¹mainä¸å­ç”Ÿæˆå™¨genä¹‹é—´å»ºç«‹ä¸€ä¸ªåŒå‘é€šé“
# è°ƒç”¨æ–¹
def main():
    g = g1()
    g.send(None)  # é¢„æ¿€

```

æœ¬æ¥åç¨‹æ˜¯é‡‡ç”¨ç”Ÿæˆå™¨æ¥å®ç°çš„,æ—§ç‰ˆæœ¬å¯ä»¥ä½¿ç”¨@coroutine+yieldå®ç°åç¨‹ï¼Œpythonä¸ºäº†å°†è¯­ä¹‰æ˜ç¡®ï¼Œ3.5ç‰ˆæœ¬å¼•å…¥äº†async/awaitå…³é”®è¯ç”¨äºå®šä¹‰åŸç”Ÿåç¨‹
```
async def downloader(url):
    return 'ok'

async def down_url(url):
    html = await downloader(url)
    return html

coro = down_url('http://www.baidu.com')
coro.send(None)  # StopIteration: ok
```

# 7.asyncioå¹¶å‘ç¼–ç¨‹
asyncioæ˜¯pythonç”¨äºè§£å†³å¼‚æ­¥IOç¼–ç¨‹çš„ä¸€æ•´å¥—è§£å†³æ–¹æ¡ˆ

* åŒ…å«å„ç§ç‰¹å®šç³»ç»Ÿå®ç°çš„æ¨¡å—åŒ–äº‹ä»¶å¾ªç¯
* ä¼ è¾“å’Œåè®®æŠ½è±¡
* åŸºäºyield fromçš„åè®®å’Œä»»åŠ¡ï¼Œå¯ä»¥è®©ä½ ç”¨é¡ºåºçš„æ–¹å¼ç¼–å†™å¹¶å‘ä»£ç 
* å½“å¿…é¡»ä½¿ç”¨ä¸€ä¸ªå°†äº§ç”Ÿé˜»å¡IOçš„è°ƒç”¨æ—¶ï¼Œæœ‰æ¥å£å¯ä»¥æŠŠè¿™ä¸ªäº‹ä»¶è½¬ç§»åˆ°çº¿ç¨‹æ± 
* æ¨¡ä»¿threadingæ¨¡å—ä¸­çš„åŒæ­¥åŸè¯­ï¼Œå¯ä»¥ç”¨åœ¨å•çº¿ç¨‹å†…çš„åç¨‹ä¹‹é—´

å¹¶å‘ç¼–ç¨‹ä¸‰è¦ç´ ï¼šäº‹ä»¶å¾ªç¯+å›è°ƒ/é©±åŠ¨ç”Ÿæˆå™¨+epoll(IOå¤šè·¯å¤ç”¨)
```
# ç®€å•è°ƒç”¨
import asyncio
async def get_html(url):
    print('start get url')
    await asyncio.sleep(2)
    print('end get url')

start_time = time.time()
loop = asyncio.get_event_loop()
tasks = [get_html('') for _ in range(5)]
loop.run_until_complete(asyncio.wait(tasks))
# loop.run_until_complete(asyncio.gather(*tasks))  # ä¸ä¸Šå¥æ•ˆæœç›¸åŒ
print(time.time()-start_time)


# gatherå’Œwaitçš„åŒºåˆ«
# gatheræ›´åŠ é«˜çº§ï¼Œå¯ä»¥è¿›è¡Œåˆ†ç»„ï¼Œå¯ä»¥å–æ¶ˆç»„ä»»åŠ¡
# group1 = ['','']
# group2 = ['','','']
# group1 = asyncio.gather(*group1)
# group2 = asyncio.gather(*group2)
# group2.cancel()
# loop.run_until_complete(asyncio.gather(group1,group2))
```

```
# futureè°ƒç”¨ï¼Œè·å–è¿”å›å€¼ï¼Œæ·»åŠ callback
async def get_html(url):
    print('start get url')
    await asyncio.sleep(2)
    return 'hello asyncio'

# ç”¨åå‡½æ•°ï¼ŒæŒ‡å®šçš„å‚æ•°éœ€è¦æ”¾åœ¨å‰é¢ï¼Œfutureæ˜¯è°ƒç”¨ä¼ å…¥çš„é»˜è®¤å‚æ•°æ”¾åœ¨æœ€å
def callback(url, future):
    print(url)
    print('have callback url')

start_time = time.time()
loop = asyncio.get_event_loop()
future = asyncio.ensure_future(get_html('myurl'))
# future = loop.create_task(get_html('myurl'))  # ä¸ä¸Šé¢æ•ˆæœç›¸åŒ
# partialæ˜¯ä¸€ä¸ªåå‡½æ•°ï¼ŒåŒ…è£…ä¸€ä¸ªå‡½æ•°å’Œå‚æ•°ï¼Œè¿”å›ä¸€ä¸ªå‡½æ•°å
future.add_done_callback(partial(callback, 'myrul'))
loop.run_until_complete(future)
print(future.result())
print(time.time()-start_time)
# start get url
# myrul
# have callback url
# hello asyncio
# 2.0035648
```
`run_until_complete`å’Œ`run_forever`çš„åŒºåˆ«ï¼šå‰è€…è¿è¡Œå®Œä¼šåœæ­¢ï¼Œåè€…ä¼šä¸€ç›´æŒ‚èµ·ã€‚åœ¨run_foreverä¸­å¦‚ä½•åœæ­¢å‘¢ï¼Ÿå› ä¸ºloopä¼šè¢«ä¼ åˆ°futureä¸­ï¼Œå› æ­¤å¯ä»¥åœ¨futureä¸­closeã€‚è¿™é‡Œloopè®¾è®¡æ˜¯ç¯çŠ¶çš„ï¼Œloop-futureï¼Œä¸å¤ªå¥½çš„è®¾è®¡æ–¹å¼ã€‚

```
# å–æ¶ˆtask
loop = asyncio.get_event_loop()
tasks = []
try:
    loop.run_until_complete(asyncio.wait(tasks))
except KeyboardInterrupt as e:
    all_tasks = asyncio.Task.all_tasks()
    for task in all_tasks:
        task.cancel()
    # ä¸‹é¢æ˜¯å›ºå®šç”¨æ³•ï¼Œstopåè¿˜éœ€è¦run_foreverï¼Œå¦åˆ™ä¼šæŠ¥é”™
    loop.stop()
    loop.run_forever()
finally:
    loop.close()
```

**åç¨‹ä¸­åµŒå¥—åç¨‹**

loopä¸­æ³¨å†Œtaskï¼Œtaskè°ƒç”¨åç¨‹ï¼Œåç¨‹è°ƒç”¨å­åç¨‹ï¼Œå­åç¨‹ç›´æ¥è¿”å›æ•°æ®ç»™taskï¼Œç­‰åˆ°å­åç¨‹æ‰§è¡Œå®Œæˆåï¼ŒæŠ›å‡ºä¸€ä¸ªstopå¼‚å¸¸ï¼Œè¢«åç¨‹æ•æ‰ï¼Œç„¶ååç¨‹åŒæ ·æŠ›å‡ºstopå¼‚å¸¸ç»™taskï¼Œç„¶åtaskæ ‡è®°ä¸ºdoneè¿”å›ç»™loopã€‚

asyncioçš„å‡ ä¸ªç‰¹æ®Šæ–¹æ³•ï¼šcall_soon(),call_later(),call_at(),call_soon_threadsafe()

çº¿ç¨‹æ± ThreadPoolExecutorä¸asyncioç›¸ç»“åˆï¼Œåœ¨åç¨‹ä¸­é›†æˆé˜»å¡IOã€‚ä¸€èˆ¬åç¨‹å†…ä¸èƒ½æ‹¥æœ‰é˜»å¡æ–¹æ³•ï¼Œå¦åˆ™ä¼šé˜»å¡æ•´ä¸ªåç¨‹è¿è¡Œï¼Œä½†æ˜¯æŸäº›æƒ…å†µä¸‹éœ€è¦è°ƒç”¨ä¸€äº›é˜»å¡æ¥å£ï¼Œè¿™æ—¶å°±éœ€è¦é›†æˆäº†ã€‚
```
import asyncio
from concurrent.futures import ThreadPoolExecutor
# å‡è®¾get_htmlæ˜¯ä¸€ä¸ªé˜»å¡çš„æ–¹æ³•
loop = asyncio.get_event_loop()
executor = ThreadPoolExecutor()
tasks = []
for i in range(20):
    url = 'http://book/{}'.format(i)
    task = loop.run_in_executor(executor, get_html, url)
    tasks.append(task)
loop.run_until_complete(asyncio.wait(tasks))
```

**asyncioåŒæ­¥å’Œé€šä¿¡**

åœ¨asyncioä¸­è°ƒç”¨asyncå‡½æ•°æ—¶ï¼Œå¦‚å¯¹ä¸€ä¸ªå…±äº«å˜é‡åˆ†åˆ«è¿›è¡ŒåŠ å‡æ“ä½œï¼Œå¦‚æœå‡½æ•°ä¸yieldæˆ–è€…awaitï¼Œé‚£ä¹ˆç”±äºæ˜¯å•çº¿ç¨‹çš„ï¼Œæ‰€ä»¥åç¨‹ä¸å†éœ€è¦é”ï¼Œå¯¹å…±äº«å˜é‡çš„æ“ä½œæ˜¯ç¬¦åˆé¢„æœŸçš„ã€‚ä½†æ˜¯å¦‚æœå‡½æ•°ä¸­æœ‰yieldæˆ–è€…awaitï¼Œé‚£ä¹ˆå¯èƒ½ä¼šäº§ç”Ÿå¯¹åŒä¸€ä¸ªèµ„æºå¤šæ¬¡ç«äº‰è°ƒç”¨çš„é—®é¢˜ï¼Œæ‰€ä»¥è¿˜æ˜¯éœ€è¦Lockã€‚è¿™æ—¶é‡‡ç”¨çš„æ˜¯asyncioçš„lockã€‚å¦‚æœä¸é‡‡ç”¨lockåŠ é”ï¼Œé‚£ä¹ˆå¯ä»¥ä½¿ç”¨Queue(ä½¿ç”¨æ–¹å¼ä¸ºawait queue.get())ã€‚å…¶å®ç”±äºåç¨‹æœ¬è´¨ä¸Šè¿˜æ˜¯å•çº¿ç¨‹çš„åŸå› ï¼Œå…¶åŒæ­¥å’Œé€šä¿¡ç›¸æ¯”çº¿ç¨‹è¦ç®€å•
```
import asyncio
import aiohttp
from asyncio import Lock, Queue
cache={}
lock = Lock()

async def get_stuff(url):
    async with lock:
        if url in cache:
            return cache[url]
        stuff = await aiohttp.request('GET', url)
        cache[url] = stuff
        return stuff
# ä¸¤ä¸ªæ–¹æ³•éƒ½ä¼šè°ƒç”¨get_stuffï¼Œå¯èƒ½ä¼šå¯¹åŒä¸€ä¸ªURLè¿›è¡Œç«äº‰è°ƒç”¨
async def parse_stuff(url):
    stuff = await get_stuff(url)
async def user_stuff(url):
    stuff = await get_stuff(url)
```
